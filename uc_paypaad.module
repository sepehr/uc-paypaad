<?php
// $Id$

/**
 * @file
 * Contains necessary hook implementations, callbacks & helpers.
 */

/**
 * Implements hook_menu().
 */
function uc_paypaad_menu() {
  $items = array();

  $items['cart/paypaad/request'] = array(
    'title' => 'Order payment request',
    'page callback' => 'uc_paypaad_request',
    'access callback' => 'uc_paypaad_access',
    'file' => 'uc_paypaad.inc',
    'type' => MENU_CALLBACK,
  );

  $items['cart/paypaad/complete'] = array(
    'title' => 'Order payment complete',
    'page callback' => 'uc_paypaad_complete',
    'access callback' => 'uc_paypaad_access',
    'file' => 'uc_paypaad.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_payment_method().
 *
 * @todo Add option to display bank logo beside the name.
 */
function uc_paypaad_payment_method() {
  if (_uc_paypaad_settings_ok()) {
    $methods[] = array(
      'id' => 'paypaad',
      'name' => t('Paypaad Payment'),
      'title' => t('Paypaad Payment'),
      'desc'  => t('Redirect to Pasargad bank paypaad gateway.'),
      'callback' => 'uc_paypaad_settings',
      'weight' => 1,
      'checkout' => TRUE,
      'no_gateway' => TRUE,
    );

    return $methods;
  }
}

/**
 * Implements hook_form_alter() for uc_cart_checkout_review_form.
 *
 * Alters the "action" attribute of the order review form,
 * so we can perform aditional actions to send user to gateway.
 */
function uc_paypaad_form_uc_cart_checkout_review_form_alter(&$form, &$form_state, $form_id) {
  // Check order identifier.
  $order_id = intval($_SESSION['cart_order']);
  if ($order_id > 0) {
    $order = uc_order_load($order_id);
    // Alter form action.
    if ($order->payment_method == 'paypaad') {
      $form['#action'] = url('cart/paypaad/request');
    }
  }
}

/**
 * Implements hook_ucga_display().
 *
 * @see http://api.ubercart.org/api/function/hook_ucga_display/2
 */
function uc_paypaad_ucga_display() {
  if (implode('/', arg()) == 'cart/paypaad/complete') {
    return TRUE;
  }
}

/**
 * Introduces Paypaad Payment settings form to Ubercart.
 */
function uc_paypaad_settings($op, &$arg1) {
  if ($op == 'settings') {
    $form = array();
    // Paypaad merchant code.
    $form['uc_paypaad_merchant'] = array(
      '#type' => 'textfield',
      '#title' => t('Merchant Code'),
      '#description' => t('Enter the merchant code provided by Pasargad Bank.'),
      '#default_value' => variable_get('uc_paypaad_merchant', ''),
      '#required' => TRUE,
    );
    // Paypaad terminal code.
    $form['uc_paypaad_terminal'] = array(
      '#type' => 'textfield',
      '#title' => t('Terminal Code'),
      '#description' => t('Enter the terminal code provided by Pasargad Bank.'),
      '#default_value' => variable_get('uc_paypaad_terminal', ''),
      '#required' => TRUE,
    );
    // Private PEM key path.
    $form['uc_paypaad_private_key'] = array(
      '#type' => 'textfield',
      '#title' => t('Private key file'),
      '#description' => t('Accessible absolute system path to your private key PEM file.'),
      '#default_value' => variable_get('uc_paypaad_private_key', ''),
      '#required' => TRUE,
    );
    // Maximum product delivery days.
    $form['uc_paypaad_max_delivery_days'] = array(
      '#type' => 'textfield',
      '#title' => t('Maximum number of delivery days'),
      '#description' => t('Maximum number of days in which the product will be delivered to customer.'),
      '#default_value' => variable_get('uc_paypaad_max_delivery_days', ''),
      '#required' => TRUE,
    );
    // Paypaad gateway URIs.
    $form['additional'] = array(
      '#type' => 'fieldset',
      '#title' => t('Additional options'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );
    // Paypaad gateway trace URI.
    $form['additional']['uc_paypaad_trace_uri'] = array(
      '#type' => 'textfield',
      '#title' => t('Paypaad gateway controller URI'),
      '#description' => t('Do not change the default value unless you checked that Paypaad docs and it has changed.'),
      '#default_value' => variable_get('uc_paypaad_trace_uri', PAYPAAD_TRACE_URI),
      '#required' => TRUE,
    );
    // Paypaad gateway controller URI.
    $form['additional']['uc_paypaad_controller_uri'] = array(
      '#type' => 'textfield',
      '#title' => t('Paypaad gateway controller URI'),
      '#description' => t('Do not change the default value unless you checked that Paypaad docs and it has changed.'),
      '#default_value' => variable_get('uc_paypaad_controller_uri', PAYPAAD_CONTROLLER_URI),
      '#required' => TRUE,
    );

    return $form;
  }
}

/**
 * Menu paths access callback.
 *
 * Ensures a free access to defined paths.
 */
function uc_paypaad_access() {
  return TRUE;
}

/**
 * Internal helper that ensures gateway settings set.
 *
 * @return
 *   TRUE if all required configs are set, FALSE otherwise.
 */
function _uc_paypaad_settings_ok() {
  return (variable_get('uc_paypaad_merchant', FALSE) &&
          variable_get('uc_paypaad_terminal', FALSE) &&
          variable_get('uc_paypaad_private_key', FALSE)) ? TRUE : FALSE;
}

