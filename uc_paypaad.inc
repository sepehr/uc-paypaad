<?php
// $Id$

/**
 * @file
 * Contains Ubercart Pasargad Bank "Paypaad" Payment callbacks & internal helpers.
 */

/**
 * Menu callback for cart/paypaad/% path, handling gateway response.
 *
 * @param $status
 *   Paypaad gateway response status.
 *   - success
 *   - failure
 */
function uc_paypaad_response($status) {
  // Load UC order object.
  $order = uc_order_load((int) $_SESSION['cart_order']);

  // Handle a successfull Paypaad payment.
  if ($status == 'success' && ($response = paypaad_response()) && $order) {
    // Enquiry payment.
    $transaction = paypaad_trace($response['transaction_reference'], array(), paypaad_settings('trace_uri', 'uc', PAYPAAD_TRACE_URI));
    // Validate Paypaad transaction.
    if (_uc_paypaad_transaction_validate($transaction, $response, $order)) {
      // TODO: Save Paypaad payment transaction.

      // TODO: Complete UC order workflow.

      // TODO: Notify user and redirect.
      drupal_set_message('done');
      drupal_goto('cart');
    }
  }

  // Handle a failed payment, Notify user.
  drupal_set_message(t('There were a problem processing your payment via Paypaad, please try again.'), 'error');
  dpm($_GET);
  // Log a watchdog error.
  watchdog(
    'uc_paypaad',
    'Paypaad payment failed for order ID %order.',
    array('%order' => $order_id),
    WATCHDOG_ERROR
  );
  // Redirect to checkout page.
  drupal_goto('cart/checkout');
}

/**
 * Internal helper to validate a Paypaad payment transaction.
 *
 * @param $transaction
 *   Transaction object generated by paypaad_trace().
 * @param $response
 *   Response array generated by paypaad_response().
 * @param $order
 *   Current customer UC order object.
 *
 * @return
 *   Boolean value.
 *
 * @see paypaad_trace()
 * @see paypaad_response()
 * @see uc_paypaad_response()
 */
function _uc_paypaad_transaction_validate($transaction, $response, $order) {
  // Value of $transaction->result is not boolean typed.
  if ($transaction['result'] == 'true' &&
      $transaction['invoice_number'] == $order->order_id &&
      $transaction['invoice_date']   == $response['invoice_date'] &&
      $transaction['invoice_number'] == $response['invoice_number'] &&
      $transaction['merchant_code']  == paypaad_settings('merchant', 'uc') &&
      $transaction['terminal_code']  == paypaad_settings('terminal', 'uc') &&
      $transaction['transaction_reference_id'] == $response['transaction_reference']) {
    return TRUE;
  }
  // Validation failed.
  return FALSE;
}

